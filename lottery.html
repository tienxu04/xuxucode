<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Xổ Số Miền Nam (GitHub Version)</title>
    <style>
        /* CSS GIAO DIỆN */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #d32f2f; margin-bottom: 25px; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 15px;}
        
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        select:focus, input:focus { border-color: #d32f2f; outline: none; }
        
        button { width: 100%; padding: 14px; background-color: #d32f2f; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: background 0.3s; }
        button:hover { background-color: #b71c1c; }
        button:disabled { background-color: #9e9e9e; cursor: wait; }

        #status-area { margin-top: 20px; padding: 15px; border-radius: 6px; text-align: center; display: none; line-height: 1.5; font-size: 15px; }
        .success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .fail { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .loading { background-color: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc; }

        .lottery-table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; border: 1px solid #ddd; display: none; table-layout: fixed; }
        .lottery-table td { border: 1px solid #ccc; padding: 10px 4px; text-align: center; font-size: 18px; font-weight: bold; color: #444; vertical-align: middle; word-wrap: break-word; }
        .lottery-table .g-label { width: 50px; font-weight: normal; color: #666; font-size: 14px; background: #f9f9f9; }
        
        .text-red { color: #d32f2f !important; font-size: 22px !important; }
        .highlight { background-color: #fff3cd; color: #d32f2f; border: 2px solid #ffc107 !important; }
        .dev-note { font-size: 12px; color: #777; text-align: center; margin-top: 20px; font-style: italic;}
    </style>
</head>
<body>

<div class="container">
    <h2>Dò Số Online</h2>
    
    <div class="control-group">
        <label>1. Chọn ngày:</label>
        <input type="date" id="dateInput">
    </div>

    <div class="control-group">
        <label>2. Chọn đài:</label>
        <select id="stationSelect">
            <option value="">-- Đang tải lịch... --</option>
        </select>
    </div>

    <div class="control-group">
        <label>3. Số vé:</label>
        <input type="number" id="numberInput" placeholder="Nhập số (VD: 94, 123456)" oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6);">
    </div>

    <button onclick="checkResult()" id="btnCheck">DÒ KẾT QUẢ NGAY</button>

    <div id="status-area"></div>

    <table class="lottery-table" id="resultTable">
        <tr><td class="g-label">ĐB</td><td colspan="12" class="text-red" id="g-db"></td></tr>
        <tr><td class="g-label">G.1</td><td colspan="12" id="g-1"></td></tr>
        <tr><td class="g-label">G.2</td><td colspan="12" id="g-2"></td></tr>
        <tr><td class="g-label" rowspan="2">G.3</td><td colspan="12" id="g-3-1"></td></tr>
        <tr><td colspan="12" id="g-3-2"></td></tr>
        <tr><td class="g-label" rowspan="2">G.4</td><td colspan="12" id="g-4-1"></td></tr>
        <tr><td colspan="12" id="g-4-2"></td></tr>
        <tr><td class="g-label">G.5</td><td colspan="12" id="g-5"></td></tr>
        <tr><td class="g-label">G.6</td><td colspan="12" id="g-6"></td></tr>
        <tr><td class="g-label">G.7</td><td colspan="12" id="g-7"></td></tr>
        <tr><td class="g-label">G.8</td><td colspan="12" class="text-red" id="g-8"></td></tr>
    </table>

    <div class="dev-note">Mẹo: Bấm F12 > Console để xem quá trình dò tìm nếu gặp lỗi.</div>
</div>

<script>
    // --- 1. CẤU HÌNH DỮ LIỆU ---
    const PROVINCE_SLUGS = {
        'xshcm': 'ho-chi-minh', 'xsdt': 'dong-thap', 'xscm': 'ca-mau',
        'xsbt': 'ben-tre', 'xsvt': 'vung-tau', 'xsbl': 'bac-lieu',
        'xsdn': 'dong-nai', 'xsct': 'can-tho', 'xsst': 'soc-trang',
        'xstn': 'tay-ninh', 'xsag': 'an-giang', 'xsbth': 'binh-thuan',
        'xsvl': 'vinh-long', 'xsbd': 'binh-duong', 'xstv': 'tra-vinh',
        'xsla': 'long-an', 'xsbp': 'binh-phuoc', 'xshg': 'hau-giang',
        'xstg': 'tien-giang', 'xskg': 'kien-giang', 'xsdl': 'lam-dong-da-lat'
    };

    const STATION_SCHEDULE = {
        1: [{name: 'TP. HCM', code: 'xshcm'}, {name: 'Đồng Tháp', code: 'xsdt'}, {name: 'Cà Mau', code: 'xscm'}],
        2: [{name: 'Bến Tre', code: 'xsbt'}, {name: 'Vũng Tàu', code: 'xsvt'}, {name: 'Bạc Liêu', code: 'xsbl'}],
        3: [{name: 'Đồng Nai', code: 'xsdn'}, {name: 'Cần Thơ', code: 'xsct'}, {name: 'Sóc Trăng', code: 'xsst'}],
        4: [{name: 'Tây Ninh', code: 'xstn'}, {name: 'An Giang', code: 'xsag'}, {name: 'Bình Thuận', code: 'xsbth'}],
        5: [{name: 'Vĩnh Long', code: 'xsvl'}, {name: 'Bình Dương', code: 'xsbd'}, {name: 'Trà Vinh', code: 'xstv'}],
        6: [{name: 'TP. HCM', code: 'xshcm'}, {name: 'Long An', code: 'xsla'}, {name: 'Bình Phước', code: 'xsbp'}, {name: 'Hậu Giang', code: 'xshg'}],
        0: [{name: 'Tiền Giang', code: 'xstg'}, {name: 'Kiên Giang', code: 'xskg'}, {name: 'Đà Lạt (Lâm Đồng)', code: 'xsdl'}]
    };

    // --- 2. LOGIC FETCH THÔNG MINH (RETRY) ---
    async function fetchRSSWithRetry(rssUrl) {
        // Danh sách Proxy để thử lần lượt
        const strategies = [
            {
                // Cách 1: AllOrigins (Trả về JSON) - Rất ổn định
                url: `https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`,
                type: 'json'
            },
            {
                // Cách 2: CodeTabs (Trả về Text) - Backup tốt
                url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(rssUrl)}`,
                type: 'text'
            }
        ];

        for (let strategy of strategies) {
            try {
                console.log(`Đang thử tải qua Proxy: ${strategy.url}`);
                const response = await fetch(strategy.url);
                if (!response.ok) throw new Error('Network response was not ok');
                
                let content = '';
                if (strategy.type === 'json') {
                    const data = await response.json();
                    content = data.contents;
                } else {
                    content = await response.text();
                }

                if (content && content.includes('<rss')) {
                    console.log("-> Tải thành công!");
                    return content;
                }
            } catch (err) {
                console.warn(`Proxy thất bại, đang thử cái tiếp theo... (${err.message})`);
            }
        }
        throw new Error("Không thể kết nối đến máy chủ xổ số. Vui lòng thử lại sau!");
    }

    // --- 3. XỬ LÝ CHÍNH ---
    async function checkResult() {
        const userNum = document.getElementById('numberInput').value.trim();
        const stationCode = document.getElementById('stationSelect').value;
        const dateInput = document.getElementById('dateInput').value;
        const btn = document.getElementById('btnCheck');
        const statusArea = document.getElementById('status-area');
        const resultTable = document.getElementById('resultTable');

        // Reset UI
        statusArea.style.display = 'none';
        resultTable.style.display = 'none';
        resetTableColors();

        if (!userNum || !stationCode || !dateInput) {
            alert("Vui lòng nhập đầy đủ thông tin!");
            return;
        }

        btn.disabled = true;
        btn.innerText = "Đang kết nối...";
        statusArea.style.display = 'block';
        statusArea.className = 'loading';
        statusArea.innerText = "Đang tải dữ liệu từ server...";

        try {
            // Tạo link RSS
            const slug = PROVINCE_SLUGS[stationCode];
            const rssUrl = `https://xskt.com.vn/rss-online/${slug}-${stationCode}.rss`;
            console.log("RSS URL gốc:", rssUrl);

            // Gọi hàm Fetch thông minh
            const xmlStr = await fetchRSSWithRetry(rssUrl);

            // Parse XML
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlStr, "text/xml");
            const items = xmlDoc.querySelectorAll("item");
            console.log(`Tìm thấy ${items.length} bản tin trong RSS.`);

            // Xử lý ngày tháng để tìm kiếm
            const [y, m, d] = dateInput.split('-');
            const searchDate = `${d}/${m}`; // Format DD/MM (VD: 15/01)
            console.log(`Đang tìm kết quả ngày: ${searchDate}`);

            let targetDesc = null;
            let foundTitle = "";

            // Duyệt qua các item để tìm ngày đúng
            for (let item of items) {
                const title = item.querySelector("title").textContent;
                // Log để debug xem nó đang đọc cái gì
                console.log(`Checking: ${title}`); 
                
                if (title.includes(searchDate)) {
                    targetDesc = item.querySelector("description").textContent;
                    foundTitle = title;
                    break;
                }
            }

            if (!targetDesc) {
                throw new Error(`Không tìm thấy kết quả ngày ${searchDate}. (Có thể chưa đến giờ quay hoặc RSS chưa cập nhật).`);
            }

            // Parse dữ liệu giải
            const parsedData = parseDescription(targetDesc);
            renderTable(parsedData);
            
            // Dò số
            let wonPrizes = [];
            for (let key in parsedData) {
                parsedData[key].forEach(winNum => {
                    if (checkMatch(userNum, winNum)) {
                        wonPrizes.push(getPrizeName(key));
                        highlightWinner(key, winNum);
                    }
                });
            }

            // Thông báo
            if (wonPrizes.length > 0) {
                let uniquePrizes = [...new Set(wonPrizes)];
                statusArea.className = 'success';
                statusArea.innerHTML = `<strong>CHÚC MỪNG!</strong><br>Vé <b>${userNum}</b> trúng: ${uniquePrizes.join(', ')}<br><small>${foundTitle}</small>`;
            } else {
                statusArea.className = 'fail';
                statusArea.innerHTML = `<strong>RẤT TIẾC!</strong><br>Vé <b>${userNum}</b> không trúng giải nào.<br><small>${foundTitle}</small>`;
            }

        } catch (error) {
            console.error(error);
            statusArea.className = 'fail';
            statusArea.innerText = "Lỗi: " + error.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "DÒ KẾT QUẢ NGAY";
        }
    }

    // --- 4. CÁC HÀM PHỤ TRỢ (HELPER) ---
    
    // Tách chuỗi description thành object giải
    function parseDescription(descText) {
        let cleanText = descText.replace(/\s+/g, ' ').trim() + " END";
        let results = { 'db': [], '1': [], '2': [], '3': [], '4': [], '5': [], '6': [], '7': [], '8': [] };
        
        const mapKeys = [
            {key: 'db', label: 'ĐB:'}, {key: '1', label: '1:'}, {key: '2', label: '2:'},
            {key: '3', label: '3:'}, {key: '4', label: '4:'}, {key: '5', label: '5:'},
            {key: '6', label: '6:'}, {key: '7', label: '7:'}, {key: '8', label: '8:'}
        ];

        for (let i = 0; i < mapKeys.length; i++) {
            let current = mapKeys[i];
            let startIndex = cleanText.indexOf(current.label);
            
            if (startIndex !== -1) {
                let tempStr = cleanText.substring(startIndex + current.label.length);
                
                // Tìm vị trí label tiếp theo gần nhất để cắt chuỗi
                let nextIndices = [];
                for(let j=i+1; j<mapKeys.length; j++) {
                     let idx = tempStr.indexOf(mapKeys[j].label);
                     if(idx !== -1) nextIndices.push(idx);
                }
                // Nếu không tìm thấy label nào phía sau, cắt đến chữ END
                let endIndex = nextIndices.length > 0 ? Math.min(...nextIndices) : tempStr.indexOf("END");

                let numStr = tempStr.substring(0, endIndex).trim();
                // Tách số dựa trên khoảng trắng hoặc dấu gạch ngang
                let numbers = numStr.split(/[\s-]+/).filter(n => n.length >= 2); 
                results[current.key] = numbers;
            }
        }
        return results;
    }

    function checkMatch(userNum, resultNum) {
        if (userNum.length > resultNum.length) return false;
        return resultNum.endsWith(userNum);
    }

    function getPrizeName(key) {
        return key === 'db' ? 'Giải Đặc Biệt' : `Giải ${key}`;
    }

    function renderTable(data) {
        document.getElementById('resultTable').style.display = 'table';
        const setText = (id, arr) => document.getElementById(id).innerText = arr.join(' - ');
        
        setText('g-db', data['db']);
        setText('g-1', data['1']);
        setText('g-2', data['2']);
        fillSplitRow('g-3-1', 'g-3-2', data['3']);
        fillSplitRow('g-4-1', 'g-4-2', data['4']);
        setText('g-5', data['5']);
        setText('g-6', data['6']);
        setText('g-7', data['7']);
        setText('g-8', data['8']);
    }

    function fillSplitRow(idRow1, idRow2, arr) {
        let mid = Math.ceil(arr.length / 2);
        document.getElementById(idRow1).innerText = arr.slice(0, mid).join(' - ');
        document.getElementById(idRow2).innerText = arr.slice(mid).join(' - ');
    }

    function highlightWinner(prizeKey, winningNum) {
        let rowIds = [];
        if (prizeKey === '3') rowIds = ['g-3-1', 'g-3-2'];
        else if (prizeKey === '4') rowIds = ['g-4-1', 'g-4-2'];
        else rowIds = [`g-${prizeKey}`];

        rowIds.forEach(id => {
            let el = document.getElementById(id);
            if(el && el.innerText.includes(winningNum)) el.classList.add('highlight');
        });
    }

    function resetTableColors() {
        document.querySelectorAll('.highlight').forEach(e => e.classList.remove('highlight'));
    }

    // Tự động load lịch hôm nay
    window.onload = function() {
        const today = new Date();
        document.getElementById('dateInput').valueAsDate = today;
        updateStations(today);
    };

    document.getElementById('dateInput').addEventListener('change', function() {
        if(this.value) updateStations(new Date(this.value));
    });

    function updateStations(dateObj) {
        const dayOfWeek = dateObj.getDay(); 
        const stations = STATION_SCHEDULE[dayOfWeek] || [];
        const select = document.getElementById('stationSelect');
        select.innerHTML = "";
        
        stations.forEach(st => {
            const option = document.createElement("option");
            option.value = st.code;
            option.text = st.name;
            select.add(option);
        });
    }
</script>

</body>
</html>
